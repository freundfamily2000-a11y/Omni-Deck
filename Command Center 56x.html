<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center v56 (Logic Updates)</title>
    <link rel="icon" type="image/png" href="image_0.png">
    <style>
        :root {
            --bg-color: #f1f5f9;       
            --column-bg: #e2e8f0;      
            --card-bg: #ffffff;
            
            --primary: #0f172a;        
            
            --accent: #3b82f6;         
            --focus-bg: #eff6ff;       
            --focus-border: #2563eb;   
            
            --text: #334155;           
            --text-light: #64748b;     
            
            --border-radius: 8px; 
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            
            /* Status Colors */
            --date-overdue: #ef4444;   /* Red */
            --date-today: #16a34a;     /* Green */
            --date-future: #334155;    /* Black (Matches Low Prio) */
            
            /* Priority Colors for Title */
            --prio-high: #dc2626;   /* Red */
            --prio-med: #16a34a;    /* Green */
            --prio-low: #334155;    /* Black */
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        header {
            background-color: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            box-shadow: var(--shadow-md);
            z-index: 20;
            flex-shrink: 0;
        }

        h1 { margin: 0; font-size: 1.3rem; font-weight: 600; letter-spacing: 0.5px; color: white; }
        
        /* --- GRID --- */
        .container { display: flex; flex-grow: 1; overflow: hidden; gap: 0; padding: 10px; }
        .column {
            background: var(--column-bg);
            border-radius: var(--border-radius);
            padding: 0 12px 12px 12px; 
            display: flex; flex-direction: column;
            overflow-y: auto;
            min-width: 350px;
            border: 1px solid #cbd5e1;
        }
        .resizer {
            width: 8px; background-color: transparent; cursor: col-resize;
            transition: background 0.2s; flex-shrink: 0; margin: 0 2px;
        }
        .resizer:hover, .resizer.resizing { background-color: var(--accent); border-radius: 4px; }

        .col-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; font-weight: 700; font-size: 0.85rem;
            color: var(--primary); text-transform: uppercase; letter-spacing: 1px;
            position: sticky; top: 0; background: var(--column-bg); z-index: 10; 
            padding-bottom: 8px;
            padding-top: 12px; 
            border-bottom: 2px solid #cbd5e1;
        }

        /* --- CARD STYLES --- */
        .card, .target-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-sm);
            border: 1px solid #e2e8f0;
            border-left: 4px solid var(--primary);
            transition: all 0.2s ease;
            position: relative;
        }
        
        .card:hover, .target-card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .target-card { border-left: 4px solid #8b5cf6; }

        /* Dragging */
        [draggable="true"] { cursor: grab; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .drag-over-sort { border-top: 4px solid var(--accent); }
        .target-card.drag-over-add, .card.drag-over-add { 
            border: 2px dashed var(--accent); 
            background-color: var(--focus-bg); 
        }

        /* Handles */
        .drag-handle { 
            cursor: grab; color: #94a3b8; font-size: 1.1rem; margin-right: 6px; 
            user-select: none; flex-shrink: 0; padding: 0 5px; 
        }
        .drag-handle:hover { color: var(--accent); }
        .drag-handle:active { cursor: grabbing; color: var(--primary); }

        .sub-handle { 
            cursor: grab; color: #94a3b8; font-size: 0.9rem; margin-left: 2px; 
            user-select: none; flex-shrink: 0; padding: 0 2px;
        }
        .sub-handle:hover { color: var(--primary); }

        body.dragging-active .card input, 
        body.dragging-active .card textarea, 
        body.dragging-active .card select,
        body.dragging-active .target-card input {
            pointer-events: none;
        }

        .card.active-focus, .target-card.active-focus {
            background-color: var(--focus-bg);
            border-left: 6px solid var(--focus-border);
            border-right: 1px solid var(--focus-border);
            border-top: 1px solid var(--focus-border);
            border-bottom: 1px solid var(--focus-border);
            box-shadow: var(--shadow-md);
        }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .card-body.hidden { display: none; }

        /* --- META & INPUTS --- */
        .card-meta {
            font-size: 0.8rem; color: var(--text-light); margin-bottom: 8px;
            display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; overflow-x: auto; 
            padding-bottom: 2px;
        }
        
        /* Updated Title Colors */
        input.title-input { 
            font-weight: bold; border: none; background: transparent; width: 100%; 
            text-overflow: ellipsis; transition: color 0.2s; 
        }
        /* Explicit specificity for title colors */
        input.title-input.title-prio-High { color: var(--prio-high) !important; }
        input.title-input.title-prio-Medium { color: var(--prio-med) !important; }
        input.title-input.title-prio-Low { color: var(--prio-low) !important; }

        /* ID Field */
        .input-id { 
            width: auto !important; 
            min-width: 25px; 
            max-width: 80px;
            flex-shrink: 0; 
            font-size: 0.75rem !important; 
            text-align: center; 
            color: #64748b; 
            background: #f1f5f9 !important; 
            border: none !important; 
            border-radius: 4px; 
            margin-left: 5px; 
            padding: 2px 4px !important;
        }
        .input-id:focus {
            outline: 1px solid var(--accent);
            background: #fff !important;
            min-width: 60px;
        }

        .input-prio { width: auto !important; flex-shrink: 0; max-width: 95px; }
        .input-url { width: 40px !important; flex-shrink: 0; }
        
        .header-calc-date { font-size: 0.75rem; font-weight: 700; margin-right: 8px; }
        .header-calc-date.overdue { color: var(--date-overdue); }
        .header-calc-date.today { color: var(--date-today); }
        .header-calc-date.future { color: var(--date-future); }

        /* Notes View/Edit Mode */
        .notes-container {
            width: 100%; min-height: 28px; margin-bottom: 8px;
            font-size: 0.85rem; line-height: 1.4;
            position: relative;
        }
        .notes-view {
            padding: 6px; border: 1px solid transparent; 
            background: #f8fafc; border-radius: 4px; color: var(--text);
            white-space: pre-wrap; word-wrap: break-word; cursor: text;
            min-height: 28px;
        }
        .notes-view:hover { background: #f1f5f9; }
        .notes-edit {
            width: 100%; padding: 6px; border: 1px solid var(--accent); border-radius: 4px;
            font-family: inherit; font-size: 0.85rem; background: #fff; color: var(--text);
            box-sizing: border-box; resize: none; display: none;
        }
        .notes-view a { color: var(--accent); text-decoration: underline; pointer-events: auto; }

        /* Subtasks */
        .subtasks { margin-top: 8px; background: #f8fafc; padding: 6px; border-radius: 4px; border: 1px solid #e2e8f0; }
        .subtask-grid-row { display: grid; grid-template-columns: 20px 1fr 105px 45px 20px 20px; gap: 4px; align-items: center; margin-bottom: 4px; }
        .add-step-grid-row { display: grid; grid-template-columns: 20px 1fr 105px 45px 40px; gap: 4px; align-items: center; margin-top: 6px; }
        
        input[type="text"], input[type="date"], select, input[type="number"] { 
            padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; 
            box-sizing: border-box; background: #fff; font-size: 0.85rem; 
            font-family: inherit; color: var(--text); transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); }
        select.prio-High, select.prio-Very { color: #ef4444; font-weight: bold; }

        .sub-date-input { font-size: 0.75rem !important; }
        .sub-est-input { font-size: 0.75rem !important; text-align: center; }
        
        .subtask-input-view {
            font-family: inherit; font-size: inherit; width: 100%; padding: 2px 4px; border-radius: 3px;
            color: var(--text); flex-grow: 1; border: 1px solid transparent; cursor: text;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .subtask-input-view:hover { border-color: #cbd5e1; background: #fff; }
        .subtask-input-view.done { text-decoration: line-through; color: var(--text-light); }
        .subtask-input-view a { color: var(--accent); pointer-events: auto; }

        .subtask-input-edit {
            border: 1px solid var(--accent) !important; background: #fff !important; 
            font-family: inherit; font-size: inherit; width: 100%; padding: 2px 4px; border-radius: 3px;
            color: var(--text); flex-grow: 1; display: none;
        }
        
        .btn-sub-del { background: none; border: none; color: #ef4444; font-weight: bold; cursor: pointer; padding: 0; font-size: 1.1rem; line-height: 1; opacity: 0.6; }
        .btn-sub-del:hover { opacity: 1; }

        /* Buttons */
        button { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; font-family: inherit; font-weight: 500; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-action { background: #fff; color: var(--text); border: 1px solid #cbd5e1; }
        .btn-sm { font-size: 0.75rem; padding: 4px 8px; }
        .btn-xs { font-size: 0.7rem; padding: 3px 6px; }
        .btn-backup { background: #3b82f6; color: white; }
        .btn-header-add { background: var(--primary); color: white; font-size: 0.75rem; padding: 4px 10px; font-weight: bold; border-radius: 12px; }
        .btn-header-toggle { background: transparent; color: var(--primary); border: 1px solid var(--primary); font-size: 0.75rem; padding: 2px 6px; margin-right: 5px; border-radius: 4px; }
        .btn-card-del { background: none; border: 1px solid #ef4444; color: #ef4444; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; }
        .btn-card-del:hover { background: #ef4444; color: white; opacity: 1; }
        .btn-toggle { background: none; color: #94a3b8; font-size: 0.8rem; padding: 2px 6px; margin-left: 5px; }
        .btn-toggle:hover { color: var(--primary); background: #e2e8f0; border-radius: 4px; }
        .btn-icon-link { background: #3b82f6; color: white; text-decoration: none; padding: 3px 6px; border-radius: 4px; font-size: 0.75rem; }
        
        .btn-meta-toggle { background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 1rem; padding: 0 4px; }
        .btn-meta-toggle:hover { color: var(--accent); }
        .btn-done-toggle { background: transparent; border: none; color: #64748b; cursor: pointer; font-size: 0.7rem; text-decoration: underline; margin-left: 10px;}

        .completed-section { margin-top: auto; border-top: 2px dashed #cbd5e1; padding-top: 10px; }
        .completed-item { font-size: 0.8rem; color: var(--text-light); padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
        .win-focus-section { margin-top: auto; border-top: 2px solid #cbd5e1; padding-top: 15px; background: var(--card-bg); padding: 15px; border-radius: 8px; text-align: center; box-shadow: var(--shadow-sm); }
        .btn-win-focus { background-color: #0078d4; color: white; padding: 10px 15px; font-weight: bold; font-size: 0.9rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 6px; }

    </style>
</head>
<body>

<header>
    <div><h1>Command Center</h1></div>
    <div style="font-weight:bold; color:#e2e8f0; font-family: 'Courier New', monospace;" id="clock">12:00 PM</div>
    <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn-backup" onclick="backupData()">‚¨á Backup</button>
        <button class="btn-success" onclick="saveData()">Save</button>
        <button class="btn-danger btn-xs" onclick="clearData()" title="Factory Reset" style="margin-left:12px; opacity:0.6;">‚ö† Reset</button>
    </div>
</header>

<div class="container" id="mainContainer">
    <div class="column" id="col1" style="width: 25%;">
        <div class="col-header">üì• Inbox</div>
        <div style="margin-bottom:10px;">
            <input type="text" id="inboxInput" style="width:100%" placeholder="Quick capture..." onkeypress="handleInboxEnter(event)">
            <button class="btn-primary" style="width:100%; margin-top:8px;" onclick="addInboxItem()">Capture</button>
        </div>
        <div id="inboxList" style="flex-grow: 1; overflow-y: auto;"></div>
        <div class="win-focus-section">
            <div style="font-weight:bold; color:var(--text); font-size:0.9rem; margin-bottom:10px;">ü™ü WINDOWS FOCUS</div>
            <button class="btn-primary btn-win-focus" onclick="window.location.href='ms-clock://focus-sessions'">
                <span>Launch Focus Session</span>
            </button>
            <div style="font-size:0.75rem; color:var(--text-light); margin-top:8px;">Opens Windows 11 Clock App</div>
        </div>
    </div>
    
    <div class="resizer" id="resizer1"></div>
    
    <div class="column" id="col2" style="width: 45%;">
        <div class="col-header">
            <span>üî• Active Stories</span>
            <div style="display:flex; align-items:center;">
                <button class="btn-header-toggle" onclick="toggleAll('task')" title="Toggle All">‚Üï</button>
                <button class="btn-header-add" onclick="addNewCard()">+ New</button>
            </div>
        </div>
        <div id="taskList"></div>
        <div class="completed-section">
            <h4 style="margin:5px 0; color:var(--text-light); font-size:0.8rem;">‚úÖ History</h4>
            <div id="completedList"></div>
            <div style="margin-top:8px; display:flex;">
                <button class="btn-sm btn-export" style="flex:1;" onclick="exportCSV()">‚¨á CSV</button>
                <button class="btn-sm" style="background:#e2e8f0; color:var(--text); flex:1;" onclick="clearCompleted()">Clear</button>
            </div>
        </div>
    </div>
    
    <div class="resizer" id="resizer2"></div>
    
    <div class="column" id="col3" style="width: 30%;">
        <div class="col-header">
            <span>üå± Long Term</span>
            <div style="display:flex; align-items:center;">
                <button class="btn-header-toggle" onclick="toggleAll('target')" title="Toggle All">‚Üï</button>
                <button class="btn-header-add" onclick="addTarget()">+ New</button>
            </div>
        </div>
        <div id="targetsList"></div>
    </div>
</div>

<script>
    let data = { inbox: [], tasks: [], completed: [], targets: [], colWidths: { c1: "25%", c2: "45%", c3: "30%" } };
    let dragHandleActive = false; 

    function esc(str) {
        if (!str) return "";
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function linkify(text) {
        if (!text) return "";
        const urlRegex = /((https?:\/\/)|(www\.))[^\s]+/ig;
        return text.replace(urlRegex, function(url) {
            let href = url;
            if (!href.match(/^https?:\/\//i)) {
                href = 'http://' + href;
            }
            return '<a href="' + href + '" target="_blank">' + url + '</a>';
        });
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function getDateStatusClass(dateStr) {
        if (!dateStr) return '';
        const today = new Date(); today.setHours(0,0,0,0);
        const [y, m, d] = dateStr.split('-');
        const targetDate = new Date(y, m-1, d);
        if (targetDate < today) return 'overdue'; // Red
        if (targetDate.getTime() === today.getTime()) return 'today'; // Green
        return 'future'; // Black
    }

    window.onload = function() {
        startClock(); 
        try {
            const saved = localStorage.getItem('baDashboardV5');
            if (saved) data = JSON.parse(saved); 
        } catch(e) { console.error(e); }
        sanitizeData();
        if(data.colWidths) {
            document.getElementById('col1').style.width = data.colWidths.c1;
            document.getElementById('col2').style.width = data.colWidths.c2;
            document.getElementById('col3').style.width = data.colWidths.c3;
        }
        setupResizers(); 
        renderAll();
    };

    function sanitizeData() {
        if (!data) data = { inbox: [], tasks: [], completed: [], targets: [] };
        [...data.tasks, ...data.targets].forEach(t => {
            if(t.priority === 'Very High') t.priority = 'High';
            if(!t.priority) t.priority = 'Medium';
            if(!t.subtasks) t.subtasks = [];
            if(!t.dueDate) t.dueDate = ''; 
            if(t.collapsed === undefined) t.collapsed = false;
            if(t.showMeta === undefined) t.showMeta = true; 
            if(t.showDone === undefined) t.showDone = true; 
            if(!t.title) t.title = "";
            if(!t.notes) t.notes = "";
            if(!t.status) t.status = 'todo';
            t.subtasks.forEach(st => {
                if(!st.date) st.date = "";
                if(!st.estimate) st.estimate = "";
            });
        });
        if(data.kcs) delete data.kcs;
    }

    function saveData() {
        data.colWidths = { 
            c1: document.getElementById('col1').style.width, 
            c2: document.getElementById('col2').style.width, 
            c3: document.getElementById('col3').style.width 
        };
        localStorage.setItem('baDashboardV5', JSON.stringify(data));
        const btn = document.querySelector('.btn-success');
        if(btn) { const old = btn.innerText; btn.innerText = "Saved!"; setTimeout(() => btn.innerText = old, 1000); }
    }
    
    function backupData() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: "application/json" }));
        a.download = `CommandCenter_Backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function renderAll() {
        renderInbox(); renderTasks(); renderCompleted(); renderTargets();
        setTimeout(() => document.querySelectorAll('.notes-edit').forEach(el => autoResize(el)), 10);
    }

    function renderList(type, listId) {
        const list = document.getElementById(listId); 
        list.innerHTML = '';
        const arr = (type === 'task') ? data.tasks : data.targets;
        
        arr.forEach((item, index) => {
            const isActive = item.status === 'active';
            const isCollapsed = isActive ? false : (item.collapsed || false);
            
            // Safe Subtask Filtering
            const safeSubtasks = item.subtasks || [];
            const datedSubtasks = safeSubtasks.filter(s => s && s.date);
            const activeDates = datedSubtasks.filter(s => !s.done).map(s => s.date).sort();
            const nextDate = activeDates.length > 0 ? activeDates[0] : "";
            const dateClass = getDateStatusClass(nextDate);
            
            // Check if all dated subtasks are complete
            const hasDated = datedSubtasks.length > 0;
            const allDatedDone = hasDated && datedSubtasks.every(s => s.done);

            // Determine Title Color
            let titleColorClass = `title-prio-${item.priority}`;
            if (allDatedDone) {
                titleColorClass = 'title-prio-Low'; // Force Black if all dated steps done
            }

            let subHTML = '';
            safeSubtasks.forEach((st, sIndex) => {
                if (!st) return;
                if (!item.showDone && st.done) return;
                const subContent = linkify(esc(st.text));

                subHTML += `
                    <div class="subtask-grid-row" draggable="true" ondragstart="handleSubDragStart(event, '${type}', ${index}, ${sIndex})" ondragover="handleDragOver(event)" ondrop="handleSubDrop(event, '${type}', ${index}, ${sIndex})" ondragend="handleDragEnd(event)">
                        <input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleSub('${type}', ${index}, ${sIndex})">
                        <div class="subtask-input-view ${st.done ? 'done' : ''}" id="subView_${type}_${index}_${sIndex}" onclick="editSub('${type}', ${index}, ${sIndex})" style="display:block">${subContent}</div>
                        <input type="text" class="subtask-input-edit" id="subEdit_${type}_${index}_${sIndex}" value="${esc(st.text)}" onblur="saveSub('${type}', ${index}, ${sIndex})">
                        <input type="date" class="sub-date-input" value="${st.date || ''}" onchange="updateSub('${type}', ${index}, ${sIndex}, 'date', this.value)">
                        <input type="text" class="sub-est-input" value="${esc(st.estimate)}" onchange="updateSub('${type}', ${index}, ${sIndex}, 'estimate', this.value)" placeholder="Est">
                        <span class="sub-handle" onmousedown="activateDrag(event, this)">‚ò∞</span>
                        <button class="btn-sub-del" onclick="deleteSub('${type}', ${index}, ${sIndex})">√ó</button>
                    </div>`;
            });

            // Meta Section
            let metaSection = '';
            let idField = '';
            let urlBtn = '';
            let toggleMetaBtn = '';
            
            if (type === 'task') {
                toggleMetaBtn = `<button class="btn-meta-toggle" onclick="toggleMeta('${type}', ${index})" title="Toggle Details">üè∑</button>`;
                
                if(item.showMeta) {
                    idField = `<input type="text" class="input-id" value="${esc(item.jiraId)}" onchange="updateTask('${type}', ${index}, 'jiraId', this.value)" placeholder="ID #">`;
                }

                if(item.showMeta) {
                    if(item.url && item.url.trim() !== '') {
                        let safeUrl = item.url.startsWith('http') ? item.url : 'https://' + item.url;
                        urlBtn = `<a href="${safeUrl}" target="_blank" class="btn-icon-link" title="Open Link">üîó</a>`;
                    }
                    metaSection = `
                        <div class="card-meta">
                            <select class="input-prio prio-${item.priority}" onchange="updateTask('${type}', ${index}, 'priority', this.value)">
                                <option value="High" ${item.priority==='High'?'selected':''}>High</option>
                                <option value="Medium" ${item.priority==='Medium'?'selected':''}>Medium</option>
                                <option value="Low" ${item.priority==='Low'?'selected':''}>Low</option>
                            </select>
                            <input type="text" class="input-url" value="${esc(item.url)}" onchange="updateTask('${type}', ${index}, 'url', this.value)" placeholder="URL">
                            ${urlBtn}
                        </div>`;
                }
            } else {
                 metaSection = `
                    <div class="card-meta">
                        <select class="input-prio prio-${item.priority}" onchange="updateTask('${type}', ${index}, 'priority', this.value)">
                            <option value="High" ${item.priority==='High'?'selected':''}>High</option>
                            <option value="Medium" ${item.priority==='Medium'?'selected':''}>Medium</option>
                            <option value="Low" ${item.priority==='Low'?'selected':''}>Low</option>
                        </select>
                    </div>`;
            }

            const startBtn = isActive 
                ? `<button class="btn-action" onclick="setTaskStatus('${type}', ${index}, 'todo')">‚è∏ Pause</button>` 
                : `<button class="btn-primary" onclick="setTaskStatus('${type}', ${index}, 'active')">‚ñ∂ Start</button>`;
            
            const cardClass = type === 'task' ? 'card' : 'target-card';
            const notesContent = linkify(esc(item.notes));

            list.innerHTML += `
                <div class="${cardClass} ${isActive ? 'active-focus' : ''}" ondragstart="handleDragStart(event, ${index}, '${type}')" ondragend="handleDragEnd(event)" ondragover="handleDragOver(event)" ondragenter="dragEnterTask(event)" ondragleave="dragLeaveTask(event)" ondrop="dropTask(event, ${index}, '${type}')">
                    <div class="card-header">
                        <div style="flex-grow:1; display:flex; align-items:center; min-width:0; margin-right:10px;">
                            <span class="drag-handle" onmousedown="activateDrag(event, this)">‚ò∞</span>
                            <input type="text" class="title-input ${titleColorClass}" value="${esc(item.title)}" onchange="updateTask('${type}', ${index}, 'title', this.value)" placeholder="Title">
                            ${idField}
                        </div>
                        <div style="display:flex; align-items:center; gap:5px; flex-shrink:0;">
                            ${nextDate ? `<span class="header-calc-date ${dateClass}">${nextDate}</span>` : ''}
                            ${isActive ? '<span style="color:#2563eb; font-weight:bold; font-size:0.8rem;">FOCUSING</span>' : ''}
                            ${toggleMetaBtn}
                            ${!isActive ? `<button class="btn-toggle" onclick="toggleCollapse('${type}', ${index})">${isCollapsed ? '‚ñ∂' : '‚ñº'}</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="card-body ${isCollapsed ? 'hidden' : ''}">
                        ${metaSection}
                        
                        <div class="notes-container">
                            <div class="notes-view" id="notesView_${type}_${index}" onclick="editNotes('${type}', ${index})" style="display:${item.notes ? 'block' : 'none'}">${notesContent}</div>
                            <textarea class="notes-edit" id="notesEdit_${type}_${index}" placeholder="Notes (URLs auto-link)..." onblur="saveNotes('${type}', ${index})" oninput="autoResize(this)" style="display:${item.notes ? 'none' : 'block'}">${esc(item.notes)}</textarea>
                        </div>
                        
                        <div class="subtasks">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <small style="font-size:0.7rem; color:#64748b;">NEXT STEPS:</small>
                                <button class="btn-done-toggle" onclick="toggleShowDone('${type}', ${index})">${item.showDone ? 'Hide Done' : 'Show Done'}</button>
                            </div>
                            ${subHTML}
                            <div class="add-step-grid-row">
                                <div></div>
                                <input type="text" id="subInput_${type}_${index}" class="subtask-input" placeholder="Add step..." onkeypress="handleSubEnter(event, '${type}', ${index})" style="background:white; border:1px solid #cbd5e1;">
                                <input type="date" id="subDate_${type}_${index}" class="sub-date-input" onkeypress="handleSubEnter(event, '${type}', ${index})">
                                <input type="text" id="subEst_${type}_${index}" class="sub-est-input" placeholder="Est" onkeypress="handleSubEnter(event, '${type}', ${index})">
                                <button class="btn-sm btn-action" onclick="addSub('${type}', ${index})">+</button>
                            </div>
                        </div>
                        
                        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; border-top:1px solid #e2e8f0; padding-top:8px;">
                            <button class="btn-card-del" onclick="deleteTask('${type}', ${index})">Delete</button>
                            <div style="display:flex; gap:5px;">${startBtn}<button class="btn-success" onclick="completeTask('${type}', ${index})">‚úÖ Done</button></div>
                        </div>
                    </div>
                </div>`;
        });
    }

    function renderTasks() { renderList('task', 'taskList'); }
    function renderTargets() { renderList('target', 'targetsList'); }

    // --- NOTES LOGIC ---
    function editNotes(type, i) {
        document.getElementById(`notesView_${type}_${i}`).style.display = 'none';
        const edit = document.getElementById(`notesEdit_${type}_${i}`);
        edit.style.display = 'block';
        edit.focus();
        autoResize(edit);
    }
    function saveNotes(type, i) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[i].notes = document.getElementById(`notesEdit_${type}_${i}`).value;
        saveData();
        renderAll(); 
    }

    // --- SUBTASK EDIT LOGIC ---
    function editSub(type, i, si) {
        document.getElementById(`subView_${type}_${i}_${si}`).style.display = 'none';
        const edit = document.getElementById(`subEdit_${type}_${i}_${si}`);
        edit.style.display = 'block';
        edit.focus();
    }
    function saveSub(type, i, si) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        const val = document.getElementById(`subEdit_${type}_${i}_${si}`).value;
        arr[i].subtasks[si].text = val;
        saveData();
        renderAll();
    }

    // --- LOGIC ---
    function updateTask(type, i, f, v) { 
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[i][f] = v; 
        saveData(); 
        if(['url','priority'].includes(f)) renderAll(); 
    }

    function toggleMeta(type, i) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[i].showMeta = !arr[i].showMeta;
        saveData();
        renderAll();
    }

    function toggleShowDone(type, i) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[i].showDone = !arr[i].showDone;
        saveData();
        renderAll();
    }

    function setTaskStatus(type, i, status) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        if (status === 'active') {
            data.tasks.forEach(t => t.status = 'todo');
            data.targets.forEach(t => t.status = 'todo');
            arr[i].status = 'active';
            toggleFocusMode(true, type, i);
        } else {
            arr[i].status = 'todo';
        }
        saveData();
        renderAll();
    }

    function toggleFocusMode(active, type, activeIndex) {
        const setCollapse = (arr, isMainArr) => {
            arr.forEach((t, idx) => {
                if (active) {
                    if (isMainArr && idx === activeIndex) t.collapsed = false;
                    else t.collapsed = true;
                } else {
                    t.collapsed = false;
                }
            });
        };
        setCollapse(data.tasks, type === 'task');
        setCollapse(data.targets, type === 'target');
    }

    function toggleAll(type) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        const anyExpanded = arr.some(t => !t.collapsed);
        arr.forEach(t => t.collapsed = anyExpanded);
        saveData();
        renderAll();
    }

    function renderCompleted() {
        const list = document.getElementById('completedList');
        if (!list) return;
        list.innerHTML = '';
        data.completed.slice(0, 50).forEach((item) => {
            list.innerHTML += `
                <div class="completed-item">
                    <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; margin-right:10px;" title="${esc(item.title)}">${esc(item.title)}</span>
                    <span style="font-size:0.7rem; color:#64748b; flex-shrink:0;">${item.date} ${item.time}</span>
                </div>`;
        });
    }

    function clearCompleted() {
        if(confirm("Clear execution history?")) {
            data.completed = [];
            saveData();
            renderCompleted();
        }
    }

    function toggleCollapse(type, index) {
        const arr = (type === 'task') ? data.tasks : data.targets;
        if (arr[index].status === 'active') return;
        arr[index].collapsed = !arr[index].collapsed;
        saveData(); renderAll();
    }

    function addNewCard() { 
        data.tasks.unshift({ title: "", jiraId: "", priority: "Medium", dueDate: "", status: 'todo', subtasks: [], notes: "", url: "", estimate: "25m", collapsed: false, showMeta: true, showDone: true }); 
        saveData(); renderTasks(); 
    }
    
    function addTarget() { 
        data.targets.unshift({ title: "", priority: "Medium", dueDate: "", status: 'todo', subtasks: [], notes: "", url: "", estimate: "Yearly", collapsed: false, showMeta: true, showDone: true }); 
        saveData(); renderTargets(); 
    }

    function addSub(type, i) { 
        const txtInput = document.getElementById(`subInput_${type}_${i}`); 
        const dateInput = document.getElementById(`subDate_${type}_${i}`); 
        const estInput = document.getElementById(`subEst_${type}_${i}`); 
        
        if(txtInput.value){ 
            const arr = (type === 'task') ? data.tasks : data.targets;
            arr[i].subtasks.push({
                text: txtInput.value,
                done: false,
                date: dateInput.value,
                estimate: estInput.value
            }); 
            txtInput.value = ''; 
            dateInput.value = '';
            estInput.value = '';
            saveData(); 
            renderAll(); 
            setTimeout(() => document.getElementById(`subInput_${type}_${i}`).focus(), 10);
        } 
    }

    function updateSub(type, ti, si, field, val) { 
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[ti].subtasks[si][field] = val; 
        saveData(); 
        if(field === 'date') renderAll();
    }

    function toggleSub(type, ti, si) { 
        const arr = (type === 'task') ? data.tasks : data.targets;
        arr[ti].subtasks[si].done = !arr[ti].subtasks[si].done; 
        saveData(); 
        renderAll(); 
    }

    function handleSubEnter(e, type, i) { if(e.key === 'Enter') addSub(type, i); }
    function deleteSub(type, taskIndex, subIndex) { const arr = (type === 'task') ? data.tasks : data.targets; arr[taskIndex].subtasks.splice(subIndex,1); saveData(); renderAll(); }
    
    function activateDrag(e, handle) {
        const draggableEl = handle.closest('.card, .target-card, .subtask-grid-row');
        if (draggableEl) draggableEl.setAttribute('draggable', 'true');
    }
    function handleDragStart(e, i, t) {
        document.body.classList.add('dragging-active'); 
        e.dataTransfer.setData("application/json", JSON.stringify({ index: i, type: t })); 
        e.dataTransfer.setDragImage(e.target.closest('.card, .target-card'), 0, 0);
        e.target.closest('.card, .target-card').classList.add('dragging'); 
    }
    function handleDragEnd(e) { 
        document.body.classList.remove('dragging-active'); 
        e.target.classList.remove('dragging'); 
        e.target.removeAttribute('draggable'); 
        document.querySelectorAll('.drag-over-sort, .drag-over-add').forEach(el => el.classList.remove('drag-over-sort', 'drag-over-add')); 
    }
    function handleDragOver(e, type) { e.preventDefault(); }
    function dragEnterTask(e) { e.currentTarget.classList.add('drag-over-sort'); }
    function dragLeaveTask(e) { e.currentTarget.classList.remove('drag-over-sort', 'drag-over-add'); }
    function dropTask(e, ti, targetType) { 
        e.preventDefault(); 
        e.currentTarget.classList.remove('drag-over-sort', 'drag-over-add'); 
        try { 
            const d = JSON.parse(e.dataTransfer.getData("application/json")); 
            const sourceArr = (d.type === 'task') ? data.tasks : (d.type === 'target') ? data.targets : data.inbox;
            const targetArr = (targetType === 'task') ? data.tasks : data.targets;

            if(d.type === targetType) { 
                const m = sourceArr.splice(d.index, 1)[0]; 
                targetArr.splice(ti, 0, m); 
                saveData(); renderAll(); 
            } else if (d.type === 'inbox') { 
                const item = data.inbox[d.index];
                targetArr[ti].subtasks.push({ text: item.text, done: false, date: "", estimate: "" });
                data.inbox.splice(d.index, 1);
                saveData(); renderAll();
            }
        } catch(e){ console.error("Drop failed:", e); } 
    }
    function handleSubDragStart(e, listType, taskIndex, subIndex) {
        e.stopPropagation();
        e.dataTransfer.setData("application/json", JSON.stringify({ listType: listType, taskIndex: taskIndex, subIndex: subIndex, type: 'subtask' }));
        e.effectAllowed = "move";
    }
    function handleSubDrop(e, targetListType, targetTaskIndex, targetSubIndex) {
        e.preventDefault();
        e.stopPropagation();
        try {
            const d = JSON.parse(e.dataTransfer.getData("application/json"));
            if(d.type === 'subtask' && d.listType === targetListType && d.taskIndex === targetTaskIndex) {
                const arr = (targetListType === 'task' ? data.tasks : data.targets)[targetTaskIndex].subtasks;
                const item = arr.splice(d.subIndex, 1)[0];
                arr.splice(targetSubIndex, 0, item);
                saveData(); renderAll();
            }
        } catch(e) {}
    }
    function deleteTask(type, i) { if(confirm("Delete?")) { const arr = (type === 'task') ? data.tasks : data.targets; arr.splice(i,1); saveData(); renderAll(); } }
    function renderInbox() { const l=document.getElementById('inboxList'); l.innerHTML=''; data.inbox.forEach((m,i)=>{ l.innerHTML+=`<div class="card" style="padding:8px;" draggable="true" ondragstart="handleDragStart(event,${i},'inbox')" ondragend="handleDragEnd(event)"><div style="margin-bottom:4px; font-size:0.9rem;">${esc(m.text)}</div><div style="display:flex; gap:5px;"><button class="btn-sm btn-success" onclick="promoteToTask(${i})">Task</button><button class="btn-sm btn-danger" onclick="deleteInbox(${i})">√ó</button></div></div>`; }); }
    function addInboxItem() { const i=document.getElementById('inboxInput'); if(i.value){ data.inbox.unshift({text:i.value}); i.value=''; saveData(); renderInbox(); } }
    function handleInboxEnter(e) { if(e.key==='Enter') addInboxItem(); }
    function deleteInbox(i) { data.inbox.splice(i,1); saveData(); renderInbox(); }
    function promoteToTask(i) { const m=data.inbox[i]; data.tasks.unshift({title:m.text, jiraId:"", priority:"Medium", dueDate:"", status:'todo', subtasks:[], notes:"", url:"", estimate:"25m", collapsed:false, showMeta:true, showDone:true}); data.inbox.splice(i,1); saveData(); renderAll(); }
    function exportCSV() { if(data.completed.length===0) { alert("No data"); return; } let c="data:text/csv;charset=utf-8,Task,Date,Time\n"; data.completed.forEach(r=>{ c+=`"${r.title.replace(/"/g,'""')}","${r.date||''}","${r.time||''}"\r\n`; }); const e=encodeURI(c); const l=document.createElement("a"); l.href=e; l.download="tasks.csv"; document.body.appendChild(l); l.click(); document.body.removeChild(l); }
    function clearData() { if(confirm("‚ö† RESET ALL DATA?")) { localStorage.clear(); location.reload(); } }
    function startClock() { const clock = document.getElementById('clock'); if(!clock) return; const u=()=>clock.innerText=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); u(); setInterval(u,1000); }
    
    function setupResizers() {
        const createResizer = function(resizer, leftCol, rightCol) {
            let x = 0; let leftWidth = 0; let rightWidth = 0;
            const mouseDownHandler = function(e) { x = e.clientX; leftWidth = leftCol.getBoundingClientRect().width; rightWidth = rightCol.getBoundingClientRect().width; resizer.classList.add('resizing'); document.addEventListener('mousemove', mouseMoveHandler); document.addEventListener('mouseup', mouseUpHandler); };
            const mouseMoveHandler = function(e) { const dx = e.clientX - x; const parentWidth = document.getElementById('mainContainer').getBoundingClientRect().width; leftCol.style.width = `${((leftWidth + dx) * 100) / parentWidth}%`; rightCol.style.width = `${((rightWidth - dx) * 100) / parentWidth}%`; };
            const mouseUpHandler = function() { resizer.classList.remove('resizing'); document.removeEventListener('mousemove', mouseMoveHandler); document.removeEventListener('mouseup', mouseUpHandler); saveData(); };
            resizer.addEventListener('mousedown', mouseDownHandler);
        };
        const r1 = document.getElementById('resizer1'); const r2 = document.getElementById('resizer2'); if(r1 && r2) { createResizer(r1, document.getElementById('col1'), document.getElementById('col2')); createResizer(r2, document.getElementById('col2'), document.getElementById('col3')); }
    }
</script>
</body>
</html>